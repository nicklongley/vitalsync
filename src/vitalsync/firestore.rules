rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ══════════════════════════════════════════════════════
    // VITALSYNC — FIRESTORE SECURITY RULES
    // Multi-tenant: each user can only access their own data
    // Garmin tokens are NEVER readable by clients
    // ══════════════════════════════════════════════════════

    // ── USER SETTINGS ──
    match /users/{uid}/settings {
      allow read: if request.auth != null && request.auth.uid == uid
                  // Block client from reading encrypted Garmin session
                  && !('garthSession' in resource.data.garmin)
                  || (request.auth.uid == uid && !resource.data.keys().hasAny(['garmin.garthSession']));
      
      // Simpler approach: allow read but use field-level security via a Cloud Function
      // that strips sensitive fields before returning
      allow read: if request.auth != null && request.auth.uid == uid;
      
      allow create: if request.auth != null && request.auth.uid == uid;
      
      allow update: if request.auth != null && request.auth.uid == uid
                    // Prevent client from writing to garmin token fields
                    && !request.resource.data.diff(resource.data).affectedKeys()
                        .hasAny(['garmin.garthSession', 'garmin.garminEmail']);
    }

    // ── GARMIN DAILY DATA ──
    match /users/{uid}/garminDailies/{date} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if false; // Cloud Functions only (Admin SDK bypasses rules)
    }

    // ── GARMIN SLEEP DATA ──
    match /users/{uid}/garminSleep/{date} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if false;
    }

    // ── ACTIVITIES ──
    match /users/{uid}/activities/{activityId} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if false; // Synced from Garmin via Cloud Functions
    }

    // ── MANUAL HEALTH LOG ──
    match /users/{uid}/healthLog/{entryId} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow create: if request.auth != null && request.auth.uid == uid
                    && request.resource.data.keys().hasAll(['type', 'date', 'enteredAt', 'data'])
                    && request.resource.data.type in [
                      'weight', 'blood_pressure', 'cholesterol',
                      'blood_glucose', 'mood', 'hydration',
                      'body_measurements', 'energy', 'nutrition',
                      'medication', 'symptom', 'lab_result', 'custom'
                    ];
      allow update: if request.auth != null && request.auth.uid == uid;
      allow delete: if request.auth != null && request.auth.uid == uid;
    }

    // ── AI INTERVENTIONS ──
    match /users/{uid}/interventions/{interventionId} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if false; // Generated by AI Cloud Functions only
    }

    // ── TRAINING PLANS ──
    match /users/{uid}/trainingPlans/{planId} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if false; // Generated by AI Cloud Functions only
    }

    // ── ACTIVITY STATS (aggregated) ──
    match /users/{uid}/activityStats/{periodKey} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if false; // Computed by Cloud Functions
    }

    // ── TRENDS ──
    match /users/{uid}/trends/{trendId} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if false;
    }

    // ── CYCLING PROFILE ──
    match /users/{uid}/cyclingProfile {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if false;
    }

    // ── LIFETIME STATS ──
    match /users/{uid}/lifetimeStats {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if false;
    }

    // ── BACKFILL JOBS ──
    match /users/{uid}/backfillJobs/{jobId} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if false;
    }

    // ── PROMPT STATE (action prompts) ──
    match /users/{uid}/promptState/{docId} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if request.auth != null && request.auth.uid == uid;
    }

    // ── AUDIT LOG (anonymised, admin only) ──
    match /auditLog/{logId} {
      allow read, write: if false; // Admin SDK only
    }

    // ── CATCH-ALL: Deny everything else ──
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
