rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ══════════════════════════════════════════════════════
    // VITALSYNC — FIRESTORE SECURITY RULES
    // Multi-tenant: each user can only access their own data
    // Garmin tokens are NEVER readable by clients
    // ══════════════════════════════════════════════════════

    // Helper: check if the request is from the document owner
    function isOwner(uid) {
      return request.auth != null && request.auth.uid == uid;
    }

    // ── USER SETTINGS ──
    // App reads/writes to users/{uid} (NOT users/{uid}/settings)
    match /users/{uid} {
      allow read: if isOwner(uid);

      allow create: if isOwner(uid);

      allow update: if isOwner(uid)
                    // Prevent client from writing to encrypted garmin token fields
                    && !request.resource.data.diff(resource.data).affectedKeys()
                        .hasAny(['garthSession', 'garminEmail']);
    }

    // ── GARMIN DAILY DATA ──
    match /users/{uid}/garminDailies/{date} {
      allow read: if isOwner(uid);
      allow write: if false; // Cloud Functions only (Admin SDK bypasses rules)
    }

    // ── GARMIN SLEEP DATA ──
    match /users/{uid}/garminSleep/{date} {
      allow read: if isOwner(uid);
      allow write: if false;
    }

    // ── ACTIVITIES ──
    match /users/{uid}/activities/{activityId} {
      allow read: if isOwner(uid);
      allow write: if false; // Synced from Garmin via Cloud Functions
    }

    // ── MANUAL HEALTH LOG ──
    match /users/{uid}/healthLog/{entryId} {
      allow read: if isOwner(uid);
      allow create: if isOwner(uid)
                    && request.resource.data.keys().hasAll(['type', 'date'])
                    && request.resource.data.type in [
                      'weight', 'blood_pressure', 'cholesterol',
                      'blood_glucose', 'mood', 'hydration',
                      'body_measurements', 'energy', 'nutrition',
                      'medication', 'symptom', 'lab_result', 'notes', 'custom'
                    ];
      allow update: if isOwner(uid);
      allow delete: if isOwner(uid);
    }

    // ── AI INTERVENTIONS ──
    match /users/{uid}/interventions/{interventionId} {
      allow read: if isOwner(uid);
      allow write: if false; // Generated by AI Cloud Functions only
    }

    // ── TRAINING PLANS ──
    match /users/{uid}/trainingPlans/{planId} {
      allow read: if isOwner(uid);
      allow create: if false; // Generated by AI Cloud Functions only
      allow update: if isOwner(uid); // Client can mark sessions as completed
      allow delete: if false;
    }

    // ── ACTIVITY STATS (aggregated) ──
    match /users/{uid}/activityStats/{periodKey} {
      allow read: if isOwner(uid);
      allow write: if false; // Computed by Cloud Functions
    }

    // ── TRENDS ──
    match /users/{uid}/trends/{trendId} {
      allow read: if isOwner(uid);
      allow write: if false;
    }

    // ── CYCLING PROFILE ──
    match /users/{uid}/cyclingProfile/{docId} {
      allow read: if isOwner(uid);
      allow write: if false;
    }

    // ── LIFETIME STATS ──
    match /users/{uid}/lifetimeStats/{docId} {
      allow read: if isOwner(uid);
      allow write: if false;
    }

    // ── BACKFILL JOBS ──
    match /users/{uid}/backfillJobs/{jobId} {
      allow read: if isOwner(uid);
      allow write: if false;
    }

    // ── PROMPT STATE (action prompts) ──
    match /users/{uid}/promptState/{docId} {
      allow read: if isOwner(uid);
      allow write: if isOwner(uid);
    }

    // ── AUDIT LOG (anonymised, admin only) ──
    match /auditLog/{logId} {
      allow read, write: if false; // Admin SDK only
    }

    // ── CATCH-ALL: Deny everything else ──
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
